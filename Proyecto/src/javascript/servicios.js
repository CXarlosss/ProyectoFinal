// @ts-check

document.addEventListener("DOMContentLoaded", () => {
  console.log("üìå DOM cargado correctamente.");

  // üìå Configuraci√≥n de la API
  const API_PORT = location.port ? `:${location.port}` : "";
  
  esperarContenedorServicios()
  cargarServicios();
  let serviciosContainer =
    /** @type {HTMLDivElement | null} */ document.getElementById(
      "servicios-container"
    );
  const modalCrearServicio =
    /** @type {HTMLDivElement | null} */ document.getElementById(
      "modal-crear-servicio"
    );
  
  const btnCerrarModal =
    /** @type {HTMLButtonElement | null} */ document.getElementById(
      "btn-cerrar-modal"
    );
    const formCrearServicio = /** @type {HTMLButtonElement | null} */ document.getElementById("crear-servicio-form");

    if (!modalCrearServicio || !formCrearServicio) {
      console.error("‚ùå No se encontr√≥ el modal o formulario de creaci√≥n de servicios.");
      return;
    }
  
    // Evento para mostrar modal
   
  // üìå Esperar que el contenedor `#servicios-container` est√© disponible
  async function esperarContenedorServicios() {
    let intentos = 0;
    const maxIntentos = 10;

    return new Promise((resolve, reject) => {
      const intervalo = setInterval(() => {
        serviciosContainer = document.getElementById("servicios-container");

        if (serviciosContainer) {
          clearInterval(intervalo);
          console.log("‚úÖ `#servicios-container` encontrado en el DOM.");
          resolve(true);
        } else if (intentos >= maxIntentos) {
          clearInterval(intervalo);
          console.error(
            "‚ùå No se encontr√≥ `#servicios-container` despu√©s de varios intentos."
          );
          reject(false);
        }

        intentos++;
      }, 300);
    });
  }

  // üìå Verificar usuario registrado
  const usuarioGuardado = localStorage.getItem("usuarioRegistrado");
  if (!usuarioGuardado) {
    alert("No hay usuario registrado.");
    window.location.href = "registrar.html";
    return;
  }

  /** @type {{ _id: string, email: string }} */
  const usuario = JSON.parse(usuarioGuardado);
  console.log("üìå Usuario cargado desde localStorage:", usuario);

  /** @type {{ servicios: { _id: string, nombre: string, descripcion: string, ubicacion: string, imagen: string, categoria: string }[], favoritos: { _id: string, nombre: string }[] }} */

  const state = {
    servicios: [],
    favoritos: [],
  };


  // @ts-ignore
  document.addEventListener("favoritos-actualizados", ({ detail: { servicioId, esFavorito } }) => {
    console.log("üìå Evento 'favoritos-actualizados' recibido en servicios.js. Actualizando botones...");

    // Buscar el bot√≥n correspondiente en la UI y actualizarlo
    document.querySelectorAll(`.btn-favorito[data-servicio-id="${servicioId}"]`).forEach(btn => {
      btn.textContent = esFavorito ? "‚òÖ Quitar de Favoritos" : "‚òÜ A√±adir a Favoritos";
      btn.classList.toggle("favorito", esFavorito);
    });
});


async function cargarServicios() {
  try {
      const serviciosAPI = await fetch(`${location.protocol}//${location.hostname}${API_PORT}/read/servicios`);
      const servicios = await serviciosAPI.json();

      console.log("üìå Servicios obtenidos despu√©s de actualizar:", servicios);

      if (!Array.isArray(servicios))
          throw new Error("‚ö†Ô∏è La API no devolvi√≥ un array v√°lido de servicios.");

      // üî• Obtener favoritos desde localStorage
      const usuarioGuardado = localStorage.getItem("usuarioRegistrado");
      const usuario = usuarioGuardado ? JSON.parse(usuarioGuardado) : null;
      const favoritos = usuario ? JSON.parse(localStorage.getItem(`favoritos_${usuario._id}`) || "[]") : [];

      // üî• Marcar los servicios como favoritos si est√°n en la lista
      const serviciosConFavoritos = servicios.map(servicio => ({
          ...servicio,
          esFavorito: favoritos.some(fav => fav._id === servicio._id)
      }));

      state.servicios = serviciosConFavoritos;

      // ‚úÖ Hacer `state` accesible globalmente
      // @ts-ignore
      window.state = state;

      // ‚úÖ Disparar evento para que `CartaSERV` reciba los servicios
      document.dispatchEvent(
          new CustomEvent("servicios-cargados", { detail: { servicios: serviciosConFavoritos } })
      );

      renderServicios(serviciosConFavoritos.slice(0, 10));
      agregarBotonCargarMas();
  } catch (error) {
      console.error("‚ùå Error al obtener servicios:", error);
  }
}


  // üìå Renderizar servicios en el DOM
  /**
   * @param {any[]} servicios
   */
  function renderServicios(servicios) {
    console.log("üìå Renderizando servicios...");

    const serviciosContainer = document.getElementById("servicios-container");
    if (!serviciosContainer) {
      console.error("‚ùå No se encontr√≥ `#servicios-container` en el DOM.");
      return;
    }

    // ‚ùó‚ùó‚ùó LIMPIAR EL CONTENEDOR ANTES DE RENDERIZAR ‚ùó‚ùó‚ùó
    serviciosContainer.innerHTML = "";

    servicios.forEach((servicio) => {
      const cartaServicio = document.createElement("carta-servicio");
      cartaServicio.setAttribute("_id", servicio._id);
      cartaServicio.setAttribute("nombre", servicio.nombre);
      cartaServicio.setAttribute("descripcion", servicio.descripcion);
      cartaServicio.setAttribute("ubicacion", servicio.ubicacion);

      cartaServicio.setAttribute("imagen", servicio.imagen);
      cartaServicio.setAttribute("emailUsuario", servicio.emailUsuario);

      console.log(`‚úÖ Asignando servicio con ID: ${servicio._id}`);

      serviciosContainer.appendChild(cartaServicio);
    });

    console.log("‚úÖ Servicios renderizados correctamente.");
  }

  // Eventos del buscador
  document.addEventListener("buscar-servicios", (event) => {
    // @ts-ignore
    console.log("üì° Evento 'buscar-servicios' detectado en servicios.js:", event.detail);
  
    if (!state.servicios || state.servicios.length === 0) {
      console.warn("‚ö†Ô∏è No hay servicios cargados todav√≠a. Esperando...");
      return;
    }
  
    // @ts-ignore
    const { busqueda } = event.detail;
    console.log("üì° Buscando servicios con el t√©rmino:", busqueda);
  
    const serviciosFiltrados = state.servicios.filter(
      (servicio) =>
        servicio.nombre.toLowerCase().includes(busqueda.toLowerCase()) ||
        servicio.descripcion.toLowerCase().includes(busqueda.toLowerCase()) ||
        servicio.ubicacion.toLowerCase().includes(busqueda.toLowerCase())
    );
  
    console.log("üîç Servicios filtrados encontrados:", serviciosFiltrados);
    renderServicios(serviciosFiltrados);
  });

  document.addEventListener("filtrar-actividades", () => {
    console.log("üì° Evento 'filtrar-actividades' capturado.");
    const filtrados = state.servicios.filter(
      (servicio) => servicio.categoria === "actividad"
    );
    renderServicios(filtrados);
  });

  document.addEventListener("filtrar-comercios", () => {
    console.log("üì° Evento 'filtrar-comercios' capturado.");
    const filtrados = state.servicios.filter(
      (servicio) => servicio.categoria === "comercio"
    );
    renderServicios(filtrados);
  });

  document.addEventListener("mostrar-todos", () => {
    console.log("üì° Evento 'mostrar-todos' capturado.");
    renderServicios(state.servicios);
  });

  document.addEventListener("crear-servicio", () => {
    console.log("üì° Evento 'crear-servicio' capturado.");
    modalCrearServicio?.classList.remove("hidden");
  });

  btnCerrarModal?.addEventListener("click", () => {
    modalCrearServicio?.classList.add("hidden");
  });

  document.addEventListener("servicios-cargados", (event) => {
    // @ts-ignore
    console.log(
      "üì° Evento 'servicios-cargados' recibido con servicios:",
      // @ts-ignore
      event.detail.servicios
    );

   
   
   
  });

   // Manejo de env√≠o del formulario
   formCrearServicio.addEventListener("submit", async (event) => {
    event.preventDefault();
    console.log("üì° Intentando crear un servicio...");

    const usuarioGuardado = localStorage.getItem("usuarioRegistrado");
    if (!usuarioGuardado) {
      alert("‚ö†Ô∏è No est√°s autenticado. Inicia sesi√≥n para crear un servicio.");
      return;
    }
    const usuario = JSON.parse(usuarioGuardado);

    const nuevoServicio = {
      // @ts-ignore
      nombre: formCrearServicio.querySelector("#nombre-servicio").value.trim(),
      // @ts-ignore
      descripcion: formCrearServicio.querySelector("#descripcion-servicio").value.trim(),
      // @ts-ignore
      ubicacion: formCrearServicio.querySelector("#ubicacion-servicio").value.trim(),
      
      // @ts-ignore
      precio: parseFloat(formCrearServicio.querySelector("#precio-servicio").value) || 0,
      // @ts-ignore
      metodoPago: formCrearServicio.querySelector("#metodo-pago-servicio").value.trim(),
      // @ts-ignore
      etiquetas: formCrearServicio.querySelector("#etiquetas-servicio").value.split(",").map(tag => tag.trim()).filter(Boolean),
      usuarioId: usuario._id,
      emailUsuario: usuario.email,
    };

    console.log("üìã Datos listos para enviar:", nuevoServicio);

    if (!nuevoServicio.nombre || !nuevoServicio.descripcion || !nuevoServicio.ubicacion) {
      alert("‚ö†Ô∏è Todos los campos obligatorios deben estar llenos.");
      return;
    }

    try {
      const response = await fetch(`${location.protocol}//${location.hostname}${API_PORT}/create/servicios`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(nuevoServicio),
      });

      if (!response.ok) {
        throw new Error(`‚ùå Error en la solicitud: ${response.statusText}`);
      }

      const apiData = await response.json();
      console.log("‚úÖ Servicio creado correctamente:", apiData);
      alert("‚úÖ Servicio creado con √©xito");

      document.dispatchEvent(new CustomEvent("servicio-creado", { detail: apiData }));
      
      // @ts-ignore
      formCrearServicio.reset();
      modalCrearServicio.classList.add("hidden");
    } catch (error) {
      console.error("‚ùå Error al crear servicio:", error);
      alert("‚ùå Hubo un error al crear el servicio.");
    }
  });
  cargarServicios();

function agregarBotonCargarMas() {
  let botonCargarMas = document.getElementById("btn-cargar-mas");
  
  // Si ya existe el bot√≥n, no lo agregamos de nuevo
  if (botonCargarMas) return;

  botonCargarMas = document.createElement("button");
  botonCargarMas.id = "btn-cargar-mas";
  botonCargarMas.textContent = "Cargar m√°s";
  botonCargarMas.style.display = "block";
  botonCargarMas.style.margin = "5px auto";
  botonCargarMas.style.padding = "10px 15px";
  botonCargarMas.style.cursor = "pointer";

  // Agregar evento para mostrar m√°s servicios
  let cantidadMostrada = 10;
  botonCargarMas.addEventListener("click", () => {
    cantidadMostrada += 10;
    renderServicios(state.servicios.slice(0, cantidadMostrada));

    // Si ya se mostraron todos, ocultar el bot√≥n
    if (cantidadMostrada >= state.servicios.length) {
      botonCargarMas.style.display = "none";
    }
  });

  document.body.appendChild(botonCargarMas);
}
});
 
  
  
 


// @ts-ignore

